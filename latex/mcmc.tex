\chapter{Metropolis--Hastings algoritmi}

\textit{Metropolis--Hastings} algoritmi on kehittelijöidenssä \textit{Nicholas Metropolisksen} (1915-1999) ja \textit{Wilfred Keith Hastings}:n (1930-2016) mukaan nimetty MCMC-menetelmä, jolla voidaan simuloida Bayesiläisessä analyysissa käytettäviä posteriori jakaumia myös silloin kun tiheys on mahdotonta määrittää analyyttisesti.

Algoritmin pohjan kehitti \textit{Stanislav Ulam} ja \textit{Metropolis} työskennellessään \textit{Los Alamosissa} ja myöhemmin \textit{Metropolis} kehitteli nykyään \textit{Metropolis-algoritmina} tunnettua algoritmiä ja esittelivät sen artikkelissa \textit{Equation of state calculations by fast computing machines}\cite{metropolis_nicholas_equation_1953}. Tämä versio algoritmista vaati, että pian esiteltävä \textit{ehdotusjakauma} on symmetrinen. Myöhemmin \textit{Hastings} laajenti algoritmin koskemaan myös epäsymmetrisiä ehdotusjakaumia artikkelissa \textit{Monte Carlo Sampling Methods Using Markov Chains and Their Applications}

\begin{merk}
	TN-jakauma $J_n(\cdot|\cdot)$ on niin sanottu \textit{ehdotusjakauma} (\textit{proposal distribution, jumping distribution}), josta \textit{MH-algoritmissa} arvotaan ehdotus tila.
\end{merk}

\begin{maar}\label{mh-maar}
	Metropolis--Hastings algoritmi on seuraavanlainen
	\begin{enumerate}
		\item Valitaan aloitus tila $\theta_0$ ja asetetaan $n=0$
		\item Generoidaan kandidaatti tila $\theta'$ satunnaisesti jakaumasta $J_n(\theta'|\theta_{n-1})$
		\item Lasketaan tiheyksien tai todennäköisyyksien suhde
		\begin{displaymath}
			r = \frac{p(\theta'|y)/J_n(\theta'|\theta_{n-1})}{p(\theta_{n-1}|y)/J_n(\theta_{n-1}|\theta')}
		\end{displaymath}
		\item Asetetaan
		\begin{displaymath}
			\theta_t= 
			\begin{cases}
				\theta', \text{todennäköisyydellä} \hspace{0.3cm} \min(r,1) \\
				\theta_{t-1}, \text{muuten}
			\end{cases}
		\end{displaymath}
	\end{enumerate}
	Jossa $J_t(\theta'|\theta^{t-1})$ on ns. ehdotusjakauma (eng. proposal distribution).
\end{maar}

\begin{lause}
	Määritelmän \ref{mh-maar} algoritmi tuottaa Markovin ketjun jolla on uniikki tasapainojakauma, ja jonka tasapainojakauma on posteriorijakauma $p(\theta|y)$, jossa $y$ on data. 
\end{lause}

\begin{proof}

	Ohitamme todistuksen, että kyseessä Markovin ketju jolla yksi tasapainojakauma, mutta todistamme toisen osan, eli että tasapainojakauma on haluttu $p(\theta|y)$ eli posteriori jakauma. Todistus nojautuu Markovin ketjun kääntyvyysominaisuuteen (\ref{kaant-disk} ja \ref{kaant-jatk}), eli
	\begin{equation}\label{kaant-mcmc}
		T(\theta_{n}|\theta_{n-1})p(\theta_{n-1}|y) = T(\theta_{n-1}|\theta_{n})p(\theta_{n}|y)
	\end{equation}
	joka on siis riittävä ehto tasapainojakauman olemassaololle. Mietitään kahta tapausta: (1) $\theta_n \neq \theta_{n-1}$ ja (2) $\theta_n = \theta_{n-1}$.
	Tapauksen (2) siirtymä voi tapahtua kahdella tavalla. Joko kohdassa 4. ehdotus $\theta'$ hylätään, tai se hyväksytään, mutta osutaan sattumanvaraisesti takaisin samaan kohtaan. Kuitenkin selvästi nähdään, että ehto \ref{kaant-mcmc} pätee tilanteessa (2).
	
	Tilanteessa (1)Siirtymätodennäköisyys pisteestä $\theta_{n-1}$ pisteeseen $\theta_n$ on
	\begin{equation}
		T(\theta_n|\theta_{n-1}) = J_n(\theta_n|\theta_{n-1})
		\min\Big( \frac{p(\theta_n|y)J_n(\theta_{n-1}|\theta_n)}{p(\theta_{n-1}|y)J_n(\theta_{n}|\theta_{n-1})},1 \Big)
	\end{equation}
	Jota voidaan muokata helposti
	\begin{equation}\label{metr-has-proof1}
		\begin{split}
			T(\theta_n|\theta_{n-1}) &= J_n(\theta_n|\theta_{n-1})
		\min\Big( \frac{p(\theta_n|y)J_n(\theta_{n-1}|\theta_n)}{p(\theta_{n-1}|y)J_n(\theta_{n}|\theta_{n-1})},1 \Big) \\
		&= \frac{1}{p(\theta_{n-1}|y)} \min \Big( p(\theta_n|y)J_n(\theta_{n-1}|\theta_n) , p(\theta_{n-1}|y)J_n(\theta_n|\theta_{n-1})  \Big)
		\end{split}
	\end{equation}
	Nähdään kuitenkin, että yhtälön \ref{metr-has-proof1} alempi yhtäläisyys on symmetrinen eli
	
	\begin{equation}\label{symmetric}
		T(\theta_{n-1}|\theta_{n})=\frac{1}{p(\theta_{n}|y)} \min \Big( p(\theta_{n-1}|y)J_n(\theta_{n}|\theta_{n-1}) , p(\theta_{n}|y)J_n(\theta_{n-1}|\theta_{n})  \Big)
	\end{equation}
	joten kerrotaan \ref{metr-has-proof1} termillä $p(\theta_{n-1}|y)$ ja hyödynnetään \ref{symmetric} ominaisuutta
	\begin{equation*}
	\begin{split}
		T(\theta_n|\theta_{n-1})p(\theta_{n-1}|y) &= \frac{1}{p(\theta_{n-1}|y)} \min \Big( p(\theta_n|y)J_n(\theta_{n-1}|\theta_n) , p(\theta_{n-1}|y)J_n(\theta_n|\theta_{n-1})  \Big) p(\theta_{n-1}|y) \\
		&= \frac{1}{p(\theta_{n}|y)} \min \Big( p(\theta_{n-1}|y)J_n(\theta_{n}|\theta_{n-1}) , p(\theta_{n}|y)J_n(\theta_{n-1}|\theta_{n})  \Big) p(\theta_{n}|y) \\
		&= T(\theta_{n-1}|\theta_{n})p(\theta_{n}|y)
	\end{split}
	\end{equation*}
	Eli myös tapauksessa (1) yhtälö \ref{kaant-mcmc} pätee.
\end{proof}

\begin{esim}
	Ajatellaan kuvitteellista tapausta, jossa meillä jatkuva kaksiulotteinen todennäköisyysjakauma, jonka tiheysfunktio on 
	\begin{equation}
		p(\theta) \varpropto \exp(-5 |\theta_1^2+\theta_2^2-1|)
	\end{equation}
	joka muodostaa regasmaisen 2-ulotteisen jakauman. Valitaan ehdotusjakaumaksi $J_n(\theta_n|\theta_{n-1})$ 2d-multinormaalijakauma 
	\begin{equation}
		J_n(\theta_n|\theta_{n-1}) \sim N(\theta_{n-1}, \sigma^2 I_2)
	\end{equation}
	jossa $I_2$ on 2x2 yksikkömatriisi ja olkoot $\sigma^2 = 0.01$. Nyt Metropolis Hastings algoritmin avulla voidaan simuloida jakaumaa $p(\theta)$ algoritmilla \ref{mh-maar}. Simuloiddaan kaksi Markovin ketjua asettemalla aloitustiloiksi $(0,0)$ ja $(5,5)$. 
	\begin{figure}[h!]
		\includegraphics[width=\textwidth]{mhexample1}
		\caption{\textit{Vasemmalla aloituspiste on (5,5), keskellä (0,0), ja oikea kuva on tiheysestimaatti.}}
		\label{kuva1}
	\end{figure}
	Simuloimme tästä Markovin ketjusta 10 000 pistettä näillä aloituspisteillä. Simuloimme myös 100 000 pistettä aloitusarvolla (0,0), joista loimme tiheysestimaatin. Tulokset löytyy kuvasta \ref{kuva1}. Kahdessa ekassa kuvassa viiva on ensimmäisen 250 pisteen polku. Selvästi nähdään, että aloituspisteellä ei ole väliä. Markovin ketjun tasapainojakauma on sama huolimatta aloituspisteestä.
	
\end{esim}






















